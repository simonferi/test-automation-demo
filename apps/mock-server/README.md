# Mock Server

FastAPI-based mock server runtime with structured logging and intelligent output formatting.

## Overview

The mock server provides a lightweight REST API mock implementation that serves predefined responses based on generated mock configurations. It features structured logging with customizable output formats.

## Features

- ✅ FastAPI-based REST API server
- ✅ Structured logging with `structlog`
- ✅ Multiple output formats: console (rich), plain, json
- ✅ Configurable host and port
- ✅ Auto-registration of routes from config
- ✅ Detailed request/response logging

## Usage

### Command Line

```powershell
# Basic usage
uv run python apps/mock-server/mock_server/main.py \
    --config artifacts/mocks/payments-api/1-0-0/mock-config.yaml

# With log format control
$env:CONSOLE_OUTPUT_FORMAT = "plain"
uv run python apps/mock-server/mock_server/main.py \
    --config artifacts/mocks/payments-api/1-0-0/mock-config.yaml

# Custom log format via CLI
uv run python apps/mock-server/mock_server/main.py \
    --config artifacts/mocks/payments-api/1-0-0/mock-config.yaml \
    --log-format plain
```

### Via Scripts

```powershell
# Automatic via universal pipeline (background job)
.\scripts\run-smoke-pipeline.ps1 -SpecPath specs/payments.yaml

# Keep mock server running
.\scripts\run-smoke-pipeline.ps1 -SpecPath specs/payments.yaml -KeepMockRuntime
```

## Parameters

| Parameter | Required | Default | Description |
|-----------|----------|---------|-------------|
| `--config` | Yes | - | Path to mock configuration YAML |
| `--log-format` | No | Auto-detected | Log format: `console`, `plain`, `json` |

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `CONSOLE_OUTPUT_FORMAT` | Controls log format globally | `auto` |

Format mapping:
- `auto` → `console` (rich structured logs with colors)
- `rich` → `console` (rich structured logs with colors)
- `plain` → `plain` (structured logs without colors)
- `json` → `json` (JSON-formatted logs)

## Log Formats

### Console Format (Rich)

Colored structured logs with custom color scheme:

```
2026-01-12T12:29:06.123456Z [info    ] runtime_starting                config_path=artifacts\mocks\payments-api\1-0-0\mock-config.yaml log_format=console servers=1 service=Payments API version=1.0.0
2026-01-12T12:29:06.124456Z [info    ] server_starting                 host=127.0.0.1 port=9101 protocol=rest server=Payments API rest mock
2026-01-12T12:29:06.143456Z [info    ] server_started                  host=127.0.0.1 port=9101 protocol=rest server=Payments API rest mock
```

Color scheme:
- **Timestamp**: dim white
- **Level**: cyan
- **Event**: bold white
- **Keys**: dim white (grey)
- **Values**: bright cyan

### Plain Format

Structured logs without colors:

```
2026-01-12T12:29:06.123456Z [info    ] runtime_starting                config_path=artifacts\mocks\payments-api\1-0-0\mock-config.yaml log_format=plain servers=1 service=Payments API version=1.0.0
2026-01-12T12:29:06.124456Z [info    ] server_starting                 host=127.0.0.1 port=9101 protocol=rest server=Payments API rest mock
```

### JSON Format

Machine-readable structured logs:

```json
{"event": "runtime_starting", "config_path": "artifacts\\mocks\\payments-api\\1-0-0\\mock-config.yaml", "log_format": "json", "servers": 1, "service": "Payments API", "version": "1.0.0", "level": "info", "timestamp": "2026-01-12T12:29:06.123456Z"}
{"event": "server_starting", "host": "127.0.0.1", "port": 9101, "protocol": "rest", "server": "Payments API rest mock", "level": "info", "timestamp": "2026-01-12T12:29:06.124456Z"}
```

## Mock Configuration

### Configuration Format

```yaml
service:
  name: Payments API
  version: 1.0.0
  protocol: rest

servers:
  - name: Payments API rest mock
    protocol: rest
    host: 127.0.0.1
    port: 9101
    routes:
      - method: GET
        path: /payments
        response:
          status: 200
          body:
            data: []
      - method: POST
        path: /payments
        response:
          status: 201
          body:
            id: "111"
            status: "completed"
```

### Generated by Mock Config Builder

The configuration is automatically generated by the mock-config-builder application:

```powershell
uv run python apps/mock-config-builder/mock_config_builder/main.py \
    --ir workspace/catalog/payments-api/1.0.0.json \
    --output-dir artifacts/mocks \
    --format yaml \
    --port rest=9101
```

## Server Lifecycle

### Startup Sequence

1. **Load Configuration** - Parse YAML config file
2. **Initialize Logging** - Configure structured logging
3. **Create FastAPI App** - Initialize web framework
4. **Register Routes** - Add mock endpoints from config
5. **Start Server** - Bind to host:port and start listening

### Request Handling

1. **Receive Request** - Log incoming request details
2. **Route Matching** - Find matching mock endpoint
3. **Generate Response** - Return predefined mock response
4. **Log Response** - Log response status and timing

### Shutdown

1. **Stop Server** - Graceful shutdown
2. **Cleanup Resources** - Close connections
3. **Log Shutdown** - Final log entry

## Architecture

### Key Components

1. **MockServer** (`server.py`)
   - FastAPI application setup
   - Route registration from config
   - Request/response handling

2. **LoggingUtils** (`logging_utils.py`)
   - Structured logging configuration
   - Custom renderers (RichConsoleRenderer)
   - Format-specific setup

3. **OutputConfig** (`output_config.py`)
   - Format configuration
   - Environment variable handling
   - Format mapping logic

### Logging Implementation

```python
class RichConsoleRenderer:
    """Custom structlog renderer with Rich library for colored output"""
    
    def __init__(self):
        self.console = Console()
    
    def __call__(self, logger, name, event_dict):
        timestamp = event_dict.pop('timestamp')
        level = event_dict.pop('level')
        event = event_dict.pop('event')
        
        # Format with custom colors
        output = f"[dim white]{timestamp}[/] [cyan][{level:8}][/] [bold white]{event:28}[/]"
        
        # Add context fields with grey keys and cyan values
        for key, value in event_dict.items():
            output += f" [dim white]{key}[/]=[bright_cyan]{value}[/]"
        
        self.console.print(output, highlight=False)
```

### Format Selection

```python
def get_log_format(cli_format: Optional[str] = None) -> str:
    """Determine log format with priority: CLI > ENV > default"""
    output_format = get_output_format(cli_format)
    
    # Map output format to log format
    if output_format in (OutputFormat.AUTO, OutputFormat.RICH):
        return "console"  # Rich colored output
    elif output_format == OutputFormat.PLAIN:
        return "plain"    # No colors
    else:
        return "json"     # Structured JSON
```

## Request Logging

### Incoming Requests

```
2026-01-12T12:29:06.580423Z [info    ] request_received                content_length=0 host=127.0.0.1 method=GET path=/payments port=9101 protocol=rest server=Payments API rest mock
```

### Served Responses

```
2026-01-12T12:29:06.632380Z [info    ] request_served                  host=127.0.0.1 latency_ms=50 method=GET operation=GET /payments path=/payments port=9101 protocol=rest server=Payments API rest mock status=200
```

## Examples

### Start with Console Format (Rich)

```powershell
$env:CONSOLE_OUTPUT_FORMAT = "rich"
uv run python apps/mock-server/mock_server/main.py \
    --config artifacts/mocks/payments-api/1-0-0/mock-config.yaml
```

### Start with Plain Format (CI/CD)

```powershell
$env:CONSOLE_OUTPUT_FORMAT = "plain"
uv run python apps/mock-server/mock_server/main.py \
    --config artifacts/mocks/payments-api/1-0-0/mock-config.yaml
```

### Start with JSON Format (Automation)

```powershell
uv run python apps/mock-server/mock_server/main.py \
    --config artifacts/mocks/payments-api/1-0-0/mock-config.yaml \
    --log-format json
```

### Background Execution (PowerShell)

```powershell
# Start as background job
$job = Start-Job -ScriptBlock {
    Set-Location "C:\path\to\project"
    $env:CONSOLE_OUTPUT_FORMAT = "rich"
    uv run python apps/mock-server/mock_server/main.py --config artifacts/mocks/payments-api/1-0-0/mock-config.yaml
}

# Check status
Get-Job $job.Id

# View output
Receive-Job $job.Id

# Stop server
Stop-Job $job.Id
Remove-Job $job.Id
```

## Testing

```powershell
# Run tests
uv run pytest apps/mock-server/tests/

# With coverage
uv run pytest apps/mock-server/tests/ --cov=mock_server

# Test specific endpoint
curl http://127.0.0.1:9101/payments
```

## Dependencies

- `fastapi>=0.100.0` - Web framework
- `uvicorn>=0.23.0` - ASGI server
- `pydantic>=2.10.0` - Data validation
- `structlog>=24.4.0` - Structured logging
- `rich>=13.9.0` - Terminal rendering
- `pyyaml>=6.0.2` - YAML parsing

## See Also

- [Main README](../../README.md)
- [Scripts Documentation](../../scripts/README.md)
- [Test Executor](../test-executor/)
- [Mock Config Builder](../mock-config-builder/)
